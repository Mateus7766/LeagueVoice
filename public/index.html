<!DOCTYPE html>
<html lang="pt-BR">


<head>
  <meta charset="UTF-8">
  <title>Chat de Voz - LoL</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #status-led {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: red;
      border: 2px solid black;
      margin-right: 10px;
    }

    .champion-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    ::-webkit-scrollbar {
      display: none;
    }

    .speaking {
      box-shadow: 0 0 10px 4px limegreen;
      border: 2px solid limegreen;
    }

    .btn-small {
      padding: 2px 8px;
      font-size: 12px;
      margin-left: auto;
    }
  </style>
</head>

<div id='loader'
  class="container text-center align-content-center w-100 h-100 bg-dark opacity-50 position-fixed top-0 start-0">
  <p class="text-light">Configurando...</p>
</div>

<body class="bg-light p-4">
  <div class="container">
    <h2 class="mb-4 text-center">Chat de Voz - League of Legends</h2>

    <div class="d-flex align-items-center mb-3">
      <div id="status-led"></div>
      <strong>League of Legends em execuÃ§Ã£o...</strong>
    </div>

    <div id="classe-aura" class="mb-3 border border-3 bg-white rounded p-3">
      <h5>VocÃª: </h5>
      <div id="meu-usuario" class="d-flex align-items-center mb-2"></div>
      <div class="d-flex gap-2">
        <button id="mute-self-btn" class="btn btn-warning btn-sm">ðŸ”‡ Mutar meu microfone</button>
        <button id="mute-all-btn" class="btn btn-secondary btn-sm">ðŸ”ˆ Parar de ouvir todos</button>
      </div>
    </div>

    <div>
      <h5>Jogadores com LeagueVoice:</h5>
      <ul id="user-list" class="list-group"></ul>
    </div>
    <p class="mt-2 text-secondary fst-italic">Lembre-se: Se algum jogador te incomodar, vocÃª pode silenciar ele.</p>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    const campeoes = [
      { nome: "Ahri", img: "https://ddragon.leagueoflegends.com/cdn/14.8.1/img/champion/Ahri.png" },
      { nome: "Garen", img: "https://ddragon.leagueoflegends.com/cdn/14.8.1/img/champion/Garen.png" },
      { nome: "Lux", img: "https://ddragon.leagueoflegends.com/cdn/14.8.1/img/champion/Lux.png" },
      { nome: "Yasuo", img: "https://ddragon.leagueoflegends.com/cdn/14.8.1/img/champion/Yasuo.png" },
      { nome: "Zed", img: "https://ddragon.leagueoflegends.com/cdn/14.8.1/img/champion/Zed.png" }
    ];

    const escolhido = campeoes[Math.floor(Math.random() * campeoes.length)];
    const nickname = escolhido.nome;
    const avatar = escolhido.img;
    let roomId = "123";

    electron.ipcRenderer.invoke("isPlaying").then(gameData => {
      const userpuuid = gameData.playerChampionSelections[0].puuid;
      const teamOne = gameData.teamOne;
      let team = 'two'
      for (player of teamOne) {
        if (player.puuid == userpuuid) {
          team = 'one'
          break;
        }
      }
      roomId = gameData.gameId + '-' + team;
      const loader = document.getElementById('loader');
      if (loader) {
        loader.remove();
      }
      startVoice();
    }).catch(err => {
      console.log("Erro ao acessar o jogo:", err);
    });



    const socket = io("http://localhost:3000");
    const peers = {};
    const audioElements = {};
    const mutedPeers = {};
    let localStream;
    let isMuted = false;
    let globalMute = false;
    let localAudioAnalyser;

    document.getElementById("meu-usuario").innerHTML = `
      <img src="${avatar}" class="champion-avatar" alt="${nickname}">
      <span>${nickname}</span>
    `;

    document.getElementById("mute-self-btn").addEventListener("click", () => {
      isMuted = !isMuted;
      localStream.getAudioTracks()[0].enabled = !isMuted;
      document.getElementById("mute-self-btn").textContent = isMuted ? "ðŸ”Š Ativar meu microfone" : "ðŸ”‡ Mutar meu microfone";
    });

    document.getElementById("mute-all-btn").addEventListener("click", () => {
      globalMute = !globalMute;
      Object.values(audioElements).forEach(audio => audio.muted = globalMute);
      document.getElementById("mute-all-btn").textContent = globalMute ? "ðŸ”Š Ouvir todos novamente" : "ðŸ”ˆ Parar de ouvir todos";
    });

    const led = document.getElementById("status-led");
    function setLedColor(color) {
      led.style.backgroundColor = color;
    }

    async function startVoice() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setLedColor("orange");


        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(localStream);
        localAudioAnalyser = audioContext.createAnalyser();
        source.connect(localAudioAnalyser);


        const dataArray = new Uint8Array(localAudioAnalyser.frequencyBinCount);
        function analyzeLocalVolume() {
          localAudioAnalyser.getByteFrequencyData(dataArray);
          const volume = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;


          if (volume > 15) {
            document.getElementById("classe-aura").classList.add("speaking");
          } else {
            document.getElementById("classe-aura").classList.remove("speaking");
          }

          requestAnimationFrame(analyzeLocalVolume);
        }

        analyzeLocalVolume();

      } catch (err) {
        console.error("Erro ao acessar microfone:", err);
        return;
      }

      socket.emit("join", { roomId, nickname, avatar });

      socket.on("peer-joined", ({ peerId }) => {
        createPeerConnection(peerId, true);
      });

      socket.on("peer-left", ({ peerId }) => {
        if (peers[peerId]) {
          peers[peerId].close();
          delete peers[peerId];
        }
        delete audioElements[peerId];
      });

      socket.on("signal", async ({ from, signal }) => {
        if (!peers[from]) createPeerConnection(from, false);
        const peer = peers[from];

        if (signal.sdp) {
          await peer.setRemoteDescription(new RTCSessionDescription(signal.sdp));
          if (signal.sdp.type === "offer") {
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            socket.emit("signal", { to: from, from: socket.id, signal: { sdp: answer } });
          }
        } else if (signal.candidate) {
          await peer.addIceCandidate(new RTCIceCandidate(signal.candidate));
        }
      });

      socket.on("update-users", (users) => {
        const ul = document.getElementById("user-list");
        ul.innerHTML = "";
        Object.entries(users).forEach(([id, user]) => {
          if (id === socket.id) return;

          const li = document.createElement("li");
          li.className = "list-group-item d-flex align-items-center";
          li.setAttribute("data-peer", id);
          li.innerHTML = `
            <img src="${user.avatar}" class="champion-avatar" alt="${user.nickname}">
            <span class="me-2">${user.nickname}</span>
            <button class="btn btn-outline-danger btn-small" data-mute-peer="${id}">ðŸ”‡</button>
          `;
          ul.appendChild(li);

          const muteBtn = li.querySelector(`[data-mute-peer="${id}"]`);
          muteBtn.addEventListener("click", () => {
            mutedPeers[id] = !mutedPeers[id];
            muteBtn.textContent = mutedPeers[id] ? "ðŸ”Š" : "ðŸ”‡";
            const audio = audioElements[id];
            if (audio) audio.muted = mutedPeers[id] || globalMute;
          });
        });
      });
    }

    function createPeerConnection(peerId, isInitiator) {
      const peer = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      peers[peerId] = peer;
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("signal", {
            to: peerId,
            from: socket.id,
            signal: { candidate: e.candidate }
          });
        }
      };

      peer.ontrack = e => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        audio.muted = mutedPeers[peerId] || globalMute;
        audioElements[peerId] = audio;

        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(e.streams[0]);
        const analyser = audioContext.createAnalyser();
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        source.connect(analyser);

        const userCard = document.querySelector(`[data-peer="${peerId}"]`);
        const THRESHOLD = 15;

        function analyzeVolume() {
          analyser.getByteFrequencyData(dataArray);
          const volume = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

          if (volume > THRESHOLD) {
            userCard?.classList.add("speaking");
          } else {
            userCard?.classList.remove("speaking");
          }

          requestAnimationFrame(analyzeVolume);
        }

        analyzeVolume();
      };

      if (isInitiator) {
        peer.createOffer().then(offer => {
          peer.setLocalDescription(offer);
          socket.emit("signal", {
            to: peerId,
            from: socket.id,
            signal: { sdp: offer }
          });
        });
      }

      setInterval(async () => {
        const stats = await peer.getStats();
        let sending = false, receiving = false;
        stats.forEach(report => {
          if (report.type === "outbound-rtp" && report.kind === "audio" && report.packetsSent > 0) sending = true;
          if (report.type === "inbound-rtp" && report.kind === "audio" && report.packetsReceived > 0) receiving = true;
        });
        setLedColor(sending && receiving ? "green" : "red");
      }, 2000);
    }
  </script>
</body>

</html>